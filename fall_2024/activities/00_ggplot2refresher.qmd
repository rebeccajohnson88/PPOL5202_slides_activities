---
title: "ggplot2refresher"
format: html
editor: visual
execute: 
  warning: false
  message: false
---

# Exploratory Data Analysis

We'll practice various data preparation/plotting tasks for exploratory data analysis (EDA).

## Exercise 1: labeled violin plot for child poverty rates

-   Load ggplot2 and tidyverse

-   Load the `midwest` data from the ggplot2 package

-   Produce a violin plot similar to the lecture slide example of the distribution of child poverty rates (`percchildbelowpovert`) for metro and non-metro counties but adding:

    -   A label with the county + state + poverty rate for the highest child poverty rate counties in each group (so one for metro areas; another for non-metro areas)
    -   A label with the county + state + poverty rate for the lowest child poverty rate counties in each group

*Hint on finding max/min counties by group*: https://stackoverflow.com/questions/24237399/how-to-select-the-rows-with-maximum-values-in-each-group-with-dplyr

*Bonus 1*: also add a text note with the county at / closest to the median poverty rate for each group

*Bonus 2*: repeat the exercise but include the facetting by state

```{r}
library(ggplot2)
library(tidyverse)
head(midwest)
summary(midwest$percchildbelowpovert)
midwest <- midwest %>%
    mutate(metro_cat = case_when(inmetro == 1 ~ "Metropolitan",
                                 inmetro == 0 ~ "Non-metropolitan",
                                 TRUE ~ NA_character_))
table(midwest$inmetro, midwest$metro_cat)

```

```{r}
childpov_mins= midwest %>% group_by(metro_cat) %>% slice_min(order_by = percchildbelowpovert)
childpov_max = midwest %>% group_by(metro_cat) %>% slice_max(order_by = percchildbelowpovert)
childpov_labels = rbind(childpov_max, childpov_mins)
```

```{r}
ggplot(midwest,
       aes(x = metro_cat, y = percchildbelowpovert)) +
  geom_violin() +
  xlab("What kind of area?") +
  ylab("Distribution: % children in poverty") +
  theme_bw(base_size = 24) +
  geom_text(data = childpov_labels, aes(label = paste(state, county, percchildbelowpovert)), position = position_dodge(0.9), vjust = 0.5) 
 
```

## Exercise 2: alluvial flow diagram for hate crimes in DC

-   Load the Hate Crimes open data file from DC's Metropolitan Police Department

-   Filter to the following type of hate crimes (as the sole coding; ignore ones that are multiple coded and feel free to ignore typos)

    -   Ethnicity/National Origin
    -   Religion
    -   Race

-   Create an alluvial flow chart where the left hand panel has the count of each different `Type of Hate Bias` and the right hand panel has flows into different `Targeted Groups`

-   If it makes it easier to interpret, you can filter to the top 10-20 most frequent types of crimes/targets

*Hint*: you'll want to do some aggregation to get counts before

*Resource*: https://cran.r-project.org/web/packages/ggalluvial/vignettes/ggalluvial.html

```{r}
library(openxlsx)
library(ggalluvial)

hc <- read.xlsx("https://mpdc.dc.gov/sites/default/files/dc/sites/mpdc/publication/attachments/Hate%20Crimes%20Open%20Data_16.xlsx")

hc_filtered = hc %>% filter(Type.of.Hate.Bias %in% c("Ethnicity/National Origin", "Race", "Religion"))
hc_toptargets = hc_filtered %>% group_by(Targeted.Group) %>% summarise(crime_count = n()) %>% top_n(crime_count, n = 15)
hc_filtered_agg = hc_filtered %>% filter(Targeted.Group %in% unique(hc_toptargets$Targeted.Group)) %>% group_by(Type.of.Hate.Bias, Targeted.Group) %>% summarise(count = n())

is_alluvia_form(as.data.frame(hc_filtered_agg), axes = 1:2, silent = TRUE)

ggplot(hc_filtered_agg,
       aes(y = count, axis1 = Type.of.Hate.Bias, axis2 = Targeted.Group)) +
  geom_alluvium(aes(fill = Type.of.Hate.Bias), width = 1/12) +
  geom_stratum(width = 1/12, fill = "black", color = "grey") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum)))

```

## Exercise 3: square area chart

-   Create a square area chart to compare two counties in Illinois in the `midwest` data:

    -   The county with the highest poverty rate

    -   The county with the lowest poverty rate

-   The square area chart should have 100 cells and color cells red to represent the count of children in poverty out of 100 (the rounded percentage) -- eg if the poverty rate is 31\\%, 31 out of the 100 squares should be red

-   *Hint*: you may want to use `geom_tile()`

```{r}


```
